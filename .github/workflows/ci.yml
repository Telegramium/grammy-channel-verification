name: CI

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Use Node.js
              uses: actions/setup-node@v6
              with:
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm run build

            - name: Test
              run: pnpm test

    release:
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push'
        permissions:
            contents: write
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check if package.json changed
              id: check_changes
              run: |
                  if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "package.json was modified"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "package.json was not modified"
                  fi

            - name: Get version from package.json
              if: steps.check_changes.outputs.changed == 'true'
              id: package_version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Detected version: $VERSION"

            - name: Check if tag exists
              if: steps.check_changes.outputs.changed == 'true'
              id: check_tag
              run: |
                  TAG="v${{ steps.package_version.outputs.version }}"
                  if git rev-parse "$TAG" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Tag $TAG already exists, skipping release"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Tag $TAG does not exist, will create release"
                  fi

            - name: Create Git tag
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "v${{ steps.package_version.outputs.version }}" -m "Release v${{ steps.package_version.outputs.version }}"
                  git push origin "v${{ steps.package_version.outputs.version }}"

            - name: Create GitHub Release
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.package_version.outputs.version }}
                  name: Release v${{ steps.package_version.outputs.version }}
                  generate_release_notes: true

            - name: Setup pnpm for Publish
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              uses: pnpm/action-setup@v4

            - name: Use Node.js for Publish
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              uses: actions/setup-node@v6
              with:
                  registry-url: 'https://registry.npmjs.org'
                  cache: 'pnpm'

            - name: Install dependencies for Publish
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              run: pnpm install --frozen-lockfile

            - name: Build for Publish
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              run: pnpm run build

            - name: Update npm to latest version (for Trusted Publishing to work)
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              run: npm install -g npm@latest

            - name: Publish to NPM
              if: steps.check_changes.outputs.changed == 'true' && steps.check_tag.outputs.exists == 'false'
              run: pnpm publish --access public --provenance
